name: Sync upstream tags

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

# Minimum major.minor to sync for each PG major version.
# Tags below these thresholds are ignored entirely.
env:
  MIN_PG15: "15.14"
  MIN_PG17: "17.6"

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch upstream tags
        run: |
          git remote add upstream https://github.com/supabase/postgres.git
          git fetch upstream --tags --force

      - name: Sync tags and dispatch builds
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"

          # Collect all clean numeric tags already in the repo
          existing=$(gh api "repos/${REPO}/git/matching-refs/tags/" --paginate \
            | jq '[.[].ref | capture("refs/tags/(?<t>[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)$") | .t]')

          # All clean numeric tags available locally (after upstream fetch),
          # filtered by the minimum major.minor thresholds
          all_tags=$(git tag -l \
            | jq -Rn --arg min15 "$MIN_PG15" --arg min17 "$MIN_PG17" '
              [ inputs
                | select(test("^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$"))
                | . as $tag
                | ($tag | split(".") | .[0] + "." + .[1]) as $major_minor
                | ($tag | split(".")[0]) as $major
                | if   $major == "15" then ($major_minor >= $min15)
                  elif $major == "17" then ($major_minor >= $min17)
                  else true
                  end
                | select(.)
                | $tag
              ]')

          # New tags = all (filtered) minus existing
          new_tags=$(jq -n --argjson all "$all_tags" --argjson existing "$existing" '$all - $existing | sort')
          new_count=$(echo "$new_tags" | jq 'length')

          echo "Found $new_count new tag(s) above minimum thresholds"

          if [[ "$new_count" -eq 0 ]]; then
            echo "Nothing to sync"
            exit 0
          fi

          echo "$new_tags" | jq -r '.[]'

          # Create tags via the GitHub API (bypasses workflow-file push protection)
          echo "$new_tags" | jq -r '.[]' | while read -r tag; do
            sha=$(git rev-parse "refs/tags/$tag")
            echo "Creating tag $tag -> $sha"
            gh api "repos/${REPO}/git/refs" \
              -f ref="refs/tags/$tag" \
              -f sha="$sha" \
              --silent || echo "  WARNING: failed to create tag $tag"
          done

          # For each PG major version among the new tags, find the highest and dispatch a build
          latest_per_major=$(echo "$new_tags" | jq -r '
            group_by(split(".")[0])
            | map(sort_by(split(".") | map(tonumber? // 0)) | last)
            | .[]
          ')

          for tag in $latest_per_major; do
            echo "Dispatching build for: $tag"
            gh workflow run build-and-publish.yml -f tag="$tag"
          done
