name: Sync upstream tags

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

# Minimum major.minor to sync for each PG major version.
# Tags below these thresholds are ignored entirely.
env:
  MIN_PG15: "15.14"
  MIN_PG17: "17.6"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      packages: read
    steps:
      - name: Find latest upstream tags and dispatch builds
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/postgres"
          REPO="${{ github.repository }}"

          # Get all clean numeric tags from upstream (no clone needed)
          latest_per_major=$(git ls-remote --tags https://github.com/supabase/postgres.git \
            | jq -Rn --arg min15 "$MIN_PG15" --arg min17 "$MIN_PG17" '
              [ inputs
                | capture("refs/tags/(?<t>[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)$")
                | .t
                | . as $tag
                | ($tag | split(".") | .[0] + "." + .[1]) as $major_minor
                | ($tag | split(".")[0]) as $major
                | if   $major == "15" then ($major_minor >= $min15)
                  elif $major == "17" then ($major_minor >= $min17)
                  else true
                  end
                | select(.)
                | $tag
              ]
              | group_by(split(".")[0])
              | map(sort_by(split(".") | map(tonumber? // 0)) | last)
              | .[]
            ')

          for tag in $latest_per_major; do
            echo "Latest upstream tag for PG $(echo "$tag" | cut -d. -f1): $tag"

            # Check if this exact version is already built in ghcr.io
            if docker buildx imagetools inspect "${IMAGE}:${tag}" >/dev/null 2>&1; then
              echo "  Already built — skipping"
              continue
            fi

            echo "  Not yet built — dispatching"
            gh workflow run build-and-publish.yml --repo "$REPO" -f tag="$tag"
          done
